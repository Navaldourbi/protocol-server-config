protocol:
  search:
    sessionData:
      - beckn_key: bap_id
        value: data.context.bap_id
      - beckn_key: bap_uri
        value: data.context.bap_uri
      - beckn_key: cityCode
        value: data.context.location.city.code || session.cityCode
      - beckn_key: countryCode
        value: data.context.location.country.code || session.countryCode

    mapping:
      - beckn_key: context.domain
        value: session.domain
      - beckn_key: context.version
        value: session.version
      - beckn_key: context.transaction_id
        value: session.transaction_id
      - beckn_key: context.message_id
        value: data.context.message_id
      - beckn_key: context.bap_id
        value: session.bap_id
      - beckn_key: context.bap_uri
        value: session.bap_uri
      - beckn_key: context.action
        value: data.context.action
      - beckn_key: context.location.city.code
        value: session.cityCode
      - beckn_key: context.location.country.code
        value: session.countryCode
      - beckn_key: context.ttl
        value: data.context.ttl

      - beckn_key: message.intent.category.descriptor.code
        value: data.message.intent.category.descriptor.code

  on_search:
    mapping:
      - beckn_key: context.bap_id
        value: session.bap_id
      - beckn_key: context.bap_uri
        value: session.bap_uri
      - beckn_key: context.bpp_id
        value: session.bpp_id
      - beckn_key: context.bpp_uri
        value: session.bpp_uri
      - beckn_key: context.location.country.code
        value: session.country
      - beckn_key: context.location.city.code
        value: session.cityCode
      - beckn_key: context.transaction_id
        value: session.currentTransactionId
      - beckn_key: context.message_id
        value: data.context.message_id
      - beckn_key: context.timestamp
        value: timestamp
      - beckn_key: context.domain
        value: session.domain
      - beckn_key: context.version
        value: session.version
      - beckn_key: context.ttl
        value: session.ttl
      - beckn_key: context.action
        value: action

      - beckn_key: message.catalog.descriptor.name
        value: session.loan_provider.name
      - beckn_key: message.catalog.providers[0].id
        value: session.loan_provider_id
      - beckn_key: message.catalog.providers[0].descriptor
        value: session.loan_provider
      - beckn_key: message.catalog.providers[0].categories
        value: session.categories
      - beckn_key: message.catalog.providers[0].items
        value: data.loan_offers
      - beckn_key: message.catalog.providers[0].payments[0].tags
        value: data.payments_tags       || session.payment_tags
        compute: buildTags(data.payments_tags || session.payment_tags)
      - beckn_key: message.catalog.providers[0].tags
        value: data.tags                || session.tags
        compute: buildTags(data.tags    || session.tags)
      - beckn_key: message.catalog.providers[0].payments[0].collected_by
        value: data.payment_collectedby || session.collectedBy
      - beckn_key: message
        value: data.error && data.message
      - beckn_key: error
        value: data.error

  select:
    sessionData:
      - beckn_key: itemId
        value: data.message.order.items[0].id
      - beckn_key: message_id
        value: data.context.message_id
      - beckn_key: bap_uri
        value: data.context.bap_uri

    mapping:
      - beckn_key: context.bap_id
        value: session.bap_id
      - beckn_key: context.bap_uri
        value: session.bap_uri
      - beckn_key: context.bpp_id
        value: session.bpp_id
      - beckn_key: context.bpp_uri
        value: session.bpp_uri
      - beckn_key: context.location.country.code
        value: session.country
      - beckn_key: context.location.city.code
        value: session.cityCode
      - beckn_key: context.transaction_id
        value: session.currentTransactionId
      - beckn_key: context.message_id
        value: data.context.message_id
      - beckn_key: context.timestamp
        value: timestamp
      - beckn_key: context.domain
        value: session.domain
      - beckn_key: context.version
        value: session.version
      - beckn_key: context.ttl
        value: session.ttl
      - beckn_key: context.action
        value: action

      - beckn_key: message.order.items
        value: data.message.order.items

  on_select:
    mapping:
      - beckn_key: context.bap_id
        value: session.bap_id
      - beckn_key: context.bap_uri
        value: session.bap_uri
      - beckn_key: context.bpp_id
        value: session.bpp_id
      - beckn_key: context.bpp_uri
        value: session.bpp_uri
      - beckn_key: context.location.country.code
        value: session.country
      - beckn_key: context.location.city.code
        value: session.cityCode
      - beckn_key: context.transaction_id
        value: session.currentTransactionId
      - beckn_key: context.message_id
        value: data.context.message_id
      - beckn_key: context.timestamp
        value: timestamp
      - beckn_key: context.domain
        value: session.domain
      - beckn_key: context.version
        value: session.version
      - beckn_key: context.ttl
        value: session.ttl
      - beckn_key: context.action
        value: action

      - beckn_key: message.order.provider.id
        value: session.loan_provider_id
      - beckn_key: message.order.provider.descriptor
        value: session.loan_provider

      - beckn_key: message.order.provider.tags
        value: data.tags                || session.tags
        compute: buildTags(data.tags    || session.tags)
      - beckn_key: message.order.items
        value: data.loan_offers

      - beckn_key: message.order.quote.id
        value: (data.amount_id || session.quote.id)

      - beckn_key: message.order.quote.price.value
        value: (data.final_amount || session.quote.amount)
      - beckn_key: message.order.quote.price.currency
        value: session.currency
      - beckn_key: message.order.quote.breakup
        value: (data.amount_breakup || session.quote.breakup)
      - beckn_key: message.order.quote.ttl
        value: (data.ttl || session.quote.ttl)

      - beckn_key: message
        value: data.error && data.message

      - beckn_key: error
        value: data.error
